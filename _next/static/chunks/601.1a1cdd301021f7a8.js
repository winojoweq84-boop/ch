"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[601],{3601:(e,o,t)=>{t.d(o,{sendLeadToWebhook:()=>s});var n=t(3018),a=t.n(n),r=t(5704);function i(e){return a().createHash("sha256").update(e.toLowerCase().trim()).digest("hex")}async function c(e){let o=function(){let e=r.env.FACEBOOK_PIXEL_ID||"",o=r.env.FACEBOOK_ACCESS_TOKEN||"",t=r.env.FACEBOOK_API_VERSION||"v18.0";return e&&o||console.warn("⚠️ Facebook Pixel ID or Access Token not found in environment variables"),{pixel_id:e,access_token:o,api_version:t}}();if(!o.pixel_id||!o.access_token)return console.warn("⚠️ Facebook configuration incomplete, skipping conversion tracking"),!1;let t={data:[{event_name:e.event_name,event_time:Math.floor(Date.parse(e.timestamp)/1e3),event_id:e.lead_id||"lead_".concat(Date.now()),event_source_url:"https://cars-vault.com",user_data:{em:[i(e.email)],ph:[i(e.phone)],fn:[i(e.name)],ct:[i(e.city)],country:[i("AE")],client_ip_address:e.ip_address,client_user_agent:e.user_agent},custom_data:{content_name:"".concat(e.brand," ").concat(e.model),content_category:"Car Valuation",content_type:"lead",value:1,currency:"USD",payout_method:e.payout_method,crypto_token:e.crypto_token,source:e.source,session_id:e.session_id,...e.custom_properties},action_source:"website"}],test_event_code:r.env.FACEBOOK_TEST_EVENT_CODE||void 0};try{console.log("\uD83D\uDE80 Sending Facebook Conversions API event:",{event_name:e.event_name,lead_id:e.lead_id,name:e.name,email:e.email,city:e.city,brand:e.brand,model:e.model,payout_method:e.payout_method});let n=await fetch("https://graph.facebook.com/".concat(o.api_version,"/").concat(o.pixel_id,"/events"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,access_token:o.access_token})});if(!n.ok){let e=await n.text().catch(()=>"Unknown error");throw Error("Facebook Conversions API request failed: ".concat(n.status," ").concat(e))}let a=await n.json();return console.log("✅ Facebook Conversions API event sent successfully:",a),!0}catch(e){return console.error("❌ Facebook Conversions API tracking failed:",e),console.log("\uD83D\uDCCB Facebook conversion data for manual processing:",{config:{pixel_id:o.pixel_id,api_version:o.api_version},data:t,error:e instanceof Error?e.message:String(e)}),!1}}async function s(e){console.log("\uD83D\uDE80 sendLeadToWebhook called with payload:",e);try{let t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjbnJoenFxaGJ0dm9iYnh2Ym54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNzU4MDIsImV4cCI6MjA3NDY1MTgwMn0.kzmzbVtRTsuUL62Gg1aTkpJ3nzMrU9_mphCn_K1aCkE",n={name:e.name,phone:e.phone,email:e.email,city:e.city,payout_method:"Crypto",crypto_token:e.token,brand:e.brand||"",model:e.model||"",telegram_sent:!1},a=await fetch("".concat("https://scnrhzqqhbtvobbxvbnx.supabase.co","/rest/v1/leads"),{method:"POST",headers:{"Content-Type":"application/json",apikey:t,Authorization:"Bearer ".concat(t),Prefer:"return=minimal"},body:JSON.stringify(n)});if(!a.ok){let e=await a.text().catch(()=>"");throw Error("Supabase insert failed: ".concat(a.status," ").concat(e))}let r=" (".concat(e.token,")");function o(e){return e.replace(/([_*\[\]()~`>#+\-=|{}.!\\])/g,"\\$1")}let i=["\uD83D\uDE97 *New Car Valuation Lead*\n","\uD83D\uDC64 *Name:* ".concat(o(String(e.name))),"\uD83D\uDCCD *Location:* ".concat(o(String(e.city))),"\uD83D\uDCDE *Phone:* ".concat(o(String(e.phone))),"\uD83D\uDCE7 *Email:* ".concat(o(String(e.email))),"\n\uD83D\uDE99 *Car Details:*","• *Brand:* ".concat(o(String(e.brand||"Not specified"))),"• *Model:* ".concat(o(String(e.model||"Not specified"))),"","\uD83D\uDCB0 *Payout Method:* ".concat(o(String("Crypto"+r))),"\n\uD83D\uDD17 *Source:* Website \\(GitHub Pages\\)","⏰ *Time:* ".concat(o(String(new Date().toLocaleString("en-US",{timeZone:"Asia/Dubai",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"}))))].join("\n"),s=await fetch("https://api.telegram.org/bot".concat("8307601497:AAGJO9dY0Gd7a1R4T_Sd7xSS_WvRm1OaBok","/sendMessage"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:"8196426209",text:i,parse_mode:"MarkdownV2",disable_web_page_preview:!0})});if(!s.ok){let e=await s.text().catch(()=>"");console.warn("Telegram send failed:",e)}console.log("✅ Lead processed successfully (Supabase + Telegram)");try{let o=function(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return{lead_id:o.leadId,name:e.name,email:e.email,phone:e.phone,city:e.city,brand:e.brand,model:e.model,payout_method:e.payoutMethod,crypto_token:e.token,event_name:"Lead",source:e.source||"website",timestamp:new Date().toISOString(),user_agent:o.userAgent,ip_address:o.ipAddress,session_id:o.sessionId,custom_properties:o.customProperties}}({name:e.name,email:e.email,phone:e.phone,city:e.city,brand:e.brand||"",model:e.model||"",payoutMethod:e.payoutMethod,token:e.token,source:e.source||"hero_form_compact"},{leadId:"lead_".concat(Date.now()),userAgent:e.userAgent,ipAddress:e.ipAddress,sessionId:e.sessionId,customProperties:{other_brand:e.otherBrand,other_model:e.otherModel,other_city:"Other"===e.city?e.otherCity:void 0}});await c(o)?console.log("✅ Facebook Conversions API tracking sent successfully"):console.warn("⚠️ Facebook Conversions API tracking failed, but lead was still processed")}catch(e){console.warn("⚠️ Facebook Conversions API tracking failed:",e)}}catch(t){let o=function(e){if(e instanceof Error)return e;if("string"==typeof e)return Error(e);try{return Error(JSON.stringify(e))}catch(o){return Error(String(e))}}(t);throw console.error("❌ Lead processing failed:",o),console.error("Error details:",{message:o.message,stack:o.stack,payload:e}),o}}}}]);